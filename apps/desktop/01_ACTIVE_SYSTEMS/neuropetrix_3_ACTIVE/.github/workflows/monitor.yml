name: Production Health Monitor

on:
  schedule:
    - cron: "*/15 * * * *"  # Her 15 dakikada bir
  workflow_dispatch:  # Manuel √ßalƒ±≈ütƒ±rma

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Check Render API Health
        run: |
          echo "üîç Checking Render API health..."
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://neuropetrix.onrender.com/health)
          echo "API Status Code: $API_STATUS"
          
          if [ "$API_STATUS" = "200" ]; then
            echo "‚úÖ Render API is healthy"
          else
            echo "‚ùå Render API health check failed"
            exit 1
          fi
          
      - name: Check Vercel Frontend Health
        run: |
          echo "üîç Checking Vercel frontend health..."
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://neuropetrix.vercel.app)
          echo "Frontend Status Code: $FRONTEND_STATUS"
          
          if [ "$FRONTEND_STATUS" = "200" ]; then
            echo "‚úÖ Vercel frontend is healthy"
          else
            echo "‚ùå Vercel frontend health check failed"
            exit 1
          fi
          
      - name: Check API Proxy
        run: |
          echo "üîç Checking API proxy..."
          PROXY_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://neuropetrix.vercel.app/api-proxy/health)
          echo "Proxy Status Code: $PROXY_STATUS"
          
          if [ "$PROXY_STATUS" = "200" ]; then
            echo "‚úÖ API proxy is working"
          else
            echo "‚ùå API proxy health check failed"
            exit 1
          fi
          
      - name: Test API Endpoints
        run: |
          echo "üîç Testing critical API endpoints..."
          
          # Test health endpoint
          curl -f https://neuropetrix.onrender.com/health || echo "‚ùå Health endpoint failed"
          
          # Test version endpoint
          curl -f https://neuropetrix.onrender.com/version || echo "‚ùå Version endpoint failed"
          
          # Test metrics endpoint
          curl -f https://neuropetrix.onrender.com/metrics || echo "‚ùå Metrics endpoint failed"
          
          echo "‚úÖ API endpoints test completed"
          
      - name: Performance Check
        run: |
          echo "üîç Checking response times..."
          
          # Check API response time
          API_TIME=$(curl -o /dev/null -s -w "%{time_total}" https://neuropetrix.onrender.com/health)
          echo "API Response Time: ${API_TIME}s"
          
          # Check frontend response time
          FRONTEND_TIME=$(curl -o /dev/null -s -w "%{time_total}" https://neuropetrix.vercel.app)
          echo "Frontend Response Time: ${FRONTEND_TIME}s"
          
          # Alert if response time is too high
          if (( $(echo "$API_TIME > 5.0" | bc -l) )); then
            echo "‚ö†Ô∏è API response time is high: ${API_TIME}s"
          fi
          
          if (( $(echo "$FRONTEND_TIME > 3.0" | bc -l) )); then
            echo "‚ö†Ô∏è Frontend response time is high: ${FRONTEND_TIME}s"
          fi
          
      - name: System Status Report
        run: |
          echo "üìä System Health Report"
          echo "======================"
          echo "Timestamp: $(date)"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo ""
          echo "üåê Services Status:"
          echo "  - Render API: $(curl -s -o /dev/null -w "%{http_code}" https://neuropetrix.onrender.com/health)"
          echo "  - Vercel Frontend: $(curl -s -o /dev/null -w "%{http_code}" https://neuropetrix.vercel.app)"
          echo "  - API Proxy: $(curl -s -o /dev/null -w "%{http_code}" https://neuropetrix.vercel.app/api-proxy/health)"
          echo ""
          echo "‚ö° Performance:"
          echo "  - API Response: $(curl -o /dev/null -s -w "%{time_total}" https://neuropetrix.onrender.com/health)s"
          echo "  - Frontend Response: $(curl -o /dev/null -s -w "%{time_total}" https://neuropetrix.vercel.app)s"
          echo ""
          echo "‚úÖ All systems operational"
